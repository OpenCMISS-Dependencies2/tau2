TAUROOT=
include $(TAUROOT)/include/Makefile
CC=$(TAU_CC) 
ARFLAGS=rcv 
CFLAGS=$(TAU_DEFS) $(TAU_INTERNAL_FLAG1) $(TAU_INCLUDE) 
INSTALLDEST = $(TAU_PREFIX_INSTALL_DIR)/$(CONFIG_ARCH)/lib





LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's GOMP DSO" 
#GOMP_AVAILABLE#LDPRELOAD_INSTALL_CMD=cp $(GOMP_LDPRELOAD_LIB) $(INSTALLDEST)/shared$(TAU_CONFIG) #ENDIF#

#CRAYXMT#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#BGL#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#CATAMOUNT#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#CRAYX1CC#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#SUNCC#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#APPLEPGI#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#HITACHI#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#CRAYXMT#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#CRAYCC#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#USE_NECCXX#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#NOSHARED#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#
#TAU_WINDOWS#LDPRELOAD_INSTALL_CMD=@echo "NOTE: Not building TAU's preload DSO" #ENDIF#


INSTALL_LD_LIB=install-ld-lib
#CRAYXMT#INSTALL_LD_LIB= #ENDIF#
#TAU_WINDOWS#INSTALL_LD_LIB= #ENDIF#
#BGL#INSTALL_LD_LIB= #ENDIF#
#CATAMOUNT#INSTALL_LD_LIB= #ENDIF#
#CRAYX1CC#INSTALL_LD_LIB= #ENDIF#
#SUNCC#INSTALL_LD_LIB= #ENDIF#
#APPLEPGI#INSTALL_LD_LIB= #ENDIF#
#HITACHI#INSTALL_LD_LIB= #ENDIF#
#CRAYXMT#INSTALL_LD_LIB= #ENDIF#
#CRAYCC#INSTALL_LD_LIB= #ENDIF#
#USE_NECCXX#INSTALL_LD_LIB= #ENDIF#


INSTALL_PRELOAD_LIB=install-preload-lib
#CRAYXMT#INSTALL_PRELOAD_LIB= #ENDIF#
#TAU_WINDOWS#INSTALL_PRELOAD_LIB= #ENDIF#
#BGL#INSTALL_PRELOAD_LIB= #ENDIF#
#CATAMOUNT#INSTALL_PRELOAD_LIB= #ENDIF#
#CRAYX1CC#INSTALL_PRELOAD_LIB= #ENDIF#
#SUNCC#INSTALL_PRELOAD_LIB= #ENDIF#
#APPLEPGI#INSTALL_PRELOAD_LIB= #ENDIF#
#HITACHI#INSTALL_PRELOAD_LIB= #ENDIF#
#CRAYXMT#INSTALL_PRELOAD_LIB= #ENDIF#
#CRAYCC#INSTALL_PRELOAD_LIB= #ENDIF#
#USE_NECCXX#INSTALL_PRELOAD_LIB= #ENDIF#
#NOSHARED#INSTALL_PRELOAD_LIB= #ENDIF#


#GOMP_AVAILABLE##GOMP_LD_LIB=libTauGompWrap.a #ENDIF#
#GOMP_AVAILABLE#GOMP_LD_LIB=libTAU-gomp.a #ENDIF#
#CRAYXMT#GOMP_LD_LIB= #ENDIF#
#TAU_WINDOWS#GOMP_LD_LIB= #ENDIF#
#BGL#GOMP_LD_LIB= #ENDIF#
#CATAMOUNT#GOMP_LD_LIB= #ENDIF#
#CRAYX1CC#GOMP_LD_LIB= #ENDIF#
#SUNCC#GOMP_LD_LIB= #ENDIF#
#APPLEPGI#GOMP_LD_LIB= #ENDIF#
#HITACHI#GOMP_LD_LIB= #ENDIF#
#CRAYXMT#GOMP_LD_LIB= #ENDIF#
#CRAYCC#GOMP_LD_LIB= #ENDIF#
#USE_NECCXX#GOMP_LD_LIB= #ENDIF#

#GOMP_AVAILABLE#GOMP_LDPRELOAD_LIB=libTAU-gomp$(TAU_SHLIBX) #ENDIF#
#CRAYXMT#GOMP_LDPRELOAD_LIB= #ENDIF#
#TAU_WINDOWS#GOMP_LDPRELOAD_LIB= #ENDIF#
#BGL#GOMP_LDPRELOAD_LIB= #ENDIF#
#CATAMOUNT#GOMP_LDPRELOAD_LIB= #ENDIF#
#CRAYX1CC#GOMP_LDPRELOAD_LIB= #ENDIF#
#SUNCC#GOMP_LDPRELOAD_LIB= #ENDIF#
#APPLEPGI#GOMP_LDPRELOAD_LIB= #ENDIF#
#HITACHI#GOMP_LDPRELOAD_LIB= #ENDIF#
#CRAYXMT#GOMP_LDPRELOAD_LIB= #ENDIF#
#CRAYCC#GOMP_LDPRELOAD_LIB= #ENDIF#
#USE_NECCXX#GOMP_LDPRELOAD_LIB= #ENDIF#
#NOSHARED#GOMP_LDPRELOAD_LIB= #ENDIF#

install: $(INSTALL_LD_LIB) $(INSTALL_PRELOAD_LIB)

$(INSTALL_LD_LIB): $(GOMP_LD_LIB)
	mkdir -p $(INSTALLDEST)/wrappers/gomp_wrapper
	cp link_options.tau $(INSTALLDEST)/wrappers/gomp_wrapper
	$(TAU_STATIC_INSTALL_CMD)

install-preload-lib: $(GOMP_LDPRELOAD_LIB)
	$(TAU_SHARED_INSTALL_CMD)

$(GOMP_LD_LIB): gomp_wrap.o omp_collector_util.o gomp_timers.o
	$(TAU_AR) $(ARFLAGS) $@ $< omp_collector_util.o gomp_timers.o

.c.o: 
	$(CC) -DTAU_LIBRARY_SOURCE $(CFLAGS) -g -c $<  -o $@

$(GOMP_LDPRELOAD_LIB): gomp_wrap_preload.o omp_collector_util.o gomp_timers.o
	# $(CC) $(TAU_SHFLAGS) $@ $(TAU_SHLIBS) -L$(INSTALLDEST) $< omp_collector_util.o gomp_timers.o -ldl -Wl,--version-script=exports_so.txt
	$(CC) $(TAU_SHFLAGS) $@ $(TAU_SHLIBS) -L$(INSTALLDEST) $< omp_collector_util.o gomp_timers.o -ldl

gomp_wrap_preload.o: gomp_wrap.c
	$(CC) -DTAU_LIBRARY_SOURCE -DTAU_PRELOAD_LIB $(CFLAGS) -g -c $< -o $@

# *CWL* This is REQUIRED for any component of TAU for a successful new build!
clean:
	/bin/rm -f *.o $(GOMP_LD_LIB) $(GOMP_LDPRELOAD_LIB)
