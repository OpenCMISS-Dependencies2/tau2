#!/usr/bin/env perl
use strict;
use File::Basename;
use Cwd qw(realpath);

my $TAUROOT="@TAUROOTDIR@";
my $TAUARCH="@ARCH@";
my $BASEDIR="$TAUROOT/$TAUARCH";
my $SICORTEX="no";
my $PREFIX="no";
my $DEFAULT_MAKEFILE="";
my $DEFAULT_BINDING="";

my $TauOptions="";
my $TauOptionsExclude="";

my $listmatching="false";
my $makefile="false";
my $getbinding="false";
my $ProfileSpecified="false";
my $TraceSpecified="false";
my $DisableSpecified="false";
my $SerialSpecified="false";
my $MPISpecified="false";
my $listoptions="false";

if (@ARGV == 0) {
    print "TAUROOT=$TAUROOT\n";
    print "TAUARCH=$TAUARCH\n";
    print "BASEDIR=$BASEDIR\n";
    print "SICORTEX=$SICORTEX\n";
    print "PREFIX=$PREFIX\n";
    print "DEFAULT_MAKEFILE=$DEFAULT_MAKEFILE\n";
    print "DEFAULT_BINDING=\"$DEFAULT_BINDING\"\n";
    exit 0
}

foreach my $argnum (0 .. $#ARGV) {
    my $arg = $ARGV[$argnum];
    if ($arg eq "profile") {
        $ProfileSpecified="true";
    } elsif ($arg eq "trace") {
        $TraceSpecified="true";
    } elsif ($arg eq "vampirtrace") {
        $TraceSpecified="true";
        $TauOptions="$TauOptions $arg";
    } elsif ($arg eq "epilog") {
        $TraceSpecified="true";
	$TauOptions="$TauOptions $arg";
    } elsif ($arg eq "disable") {
        $DisableSpecified="true";
    } elsif ($arg eq "--list-matching") {
        $listmatching="true";
    } elsif ($arg eq "--makefile") {
        $makefile="true";
    } elsif ($arg eq "--list-options") {
        $listoptions="true";
    } elsif ($arg eq "--binding") {
        $getbinding="true";
    } elsif ($arg eq "serial") {
        $SerialSpecified="true";
    } elsif ($arg eq "mpi") {
        $MPISpecified="true";
	$TauOptions="$TauOptions $arg";
    } else {
	$TauOptions="$TauOptions $arg";
    }
}



if ("$ProfileSpecified" eq "false" && "$TraceSpecified" eq "false") {
    $ProfileSpecified="true";
}

if ("$SerialSpecified" eq "true") {
    $TauOptionsExclude="mpi";
}

if ("$MPISpecified" eq "false" && $SerialSpecified eq "false") {
    $TauOptions="$TauOptions mpi";
}

if ("$ProfileSpecified" eq "true" && "$TraceSpecified" eq "false") {
    $TauOptionsExclude="$TauOptionsExclude trace";
} elsif ("$ProfileSpecified" eq "true" && "$TraceSpecified" eq "true") {
    $TauOptions="$TauOptions profile trace"
} elsif ("$ProfileSpecified" eq "false" && "$TraceSpecified" eq "true") {
    $TauOptionsExclude="$TauOptionsExclude profile";
    $TauOptions="$TauOptions trace";
}

if ("$DisableSpecified" eq "false") {
    $TauOptionsExclude="$TauOptionsExclude disable";
} else {
    $TauOptions="";
}

my $bindingsdir;
my @bindings;

if ($makefile eq "true") {
    if ("$SICORTEX" eq "yes") {
	$bindingsdir="$PREFIX/lib64";
	@bindings=`ls $PREFIX/share/TAU/64/Makefile.tau*`;
    } else {
	$bindingsdir="$BASEDIR/lib";
	@bindings=`ls $bindingsdir/Makefile.tau*`
    }
} else {
    if ("$SICORTEX" eq "yes") {
	$bindingsdir="$PREFIX/lib64";
	@bindings=`ls $PREFIX/lib64 | grep TAU-shared`;
    } else {
	$bindingsdir="$BASEDIR/lib";
	@bindings=`ls $BASEDIR/lib | grep shared`;
    }
}

chomp(@bindings);

if ($listoptions eq "true") {
    my %options;
    foreach my $b (@bindings) {
	my @opts = split ('-',$b);
	foreach my $o (@opts) {
	    $options{$o} = 1;
	}
    }
    delete $options{"shared"};
    delete $options{"opari"};
    $options{"profile"} = 1;
    $options{"serial"} = 1;
    my @keys = keys(%options);
    @keys = sort @keys;
    map{$_ = uc($_)} @keys;
    $"=","; # sets delimeter to comma for printing arrays
    print "@keys\n";
    $"=" "; # set it back to space
    exit
}

my @opts = split(" ", $TauOptions);
foreach my $opt (@opts) {
    my $newbindings="";
    foreach my $b (@bindings) {
	my $proc="-$b-";
	if ($proc =~ /-$opt-/) {
	    $newbindings="$newbindings $b";
	}
    }
    @bindings=split(" ",$newbindings);
}

my @opts = split(" ", $TauOptionsExclude);
foreach my $opt (@opts) {
    my $newbindings="";
    chomp(@bindings);
    foreach my $b (@bindings) {
	my $proc="-$b-";
	if (!($proc =~ /-$opt-/)) {
	    $newbindings="$newbindings $b";
	}
    }
    @bindings=split(" ",$newbindings);
}

my @sorted = sort { length $a <=> length $b } @bindings;

if ($#sorted <= 0) {
    die "Error: No matching binding for '$TauOptions' in directory $bindingsdir"
}

if ("$listmatching" eq "true" ) {
    print "@bindings\n";
} else { 
    print "$sorted[0]\n";
}

