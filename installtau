#!/bin/sh 

#Variables
pdt=no
pdtcomp=no
dyninst=no
arch=no
cc=no
cxx=no
fortran=no
mpiinc=no
mpilib=no
tag=no
tagopt=
vtf=no
vtfopt=
useropt=no
papi=no
opari=no
mpilibrary=no
tauprefix=unknown

# PARSE COMMAND LINE SWITCHES
###############################################################
for arg in "$@";
do
  case $arg in

  -arch=*)
    arch=yes
    archdir=`echo $arg | sed -e 's/-arch=//'`
    shift
    ;;

  -fortran=*)
    fortran=yes
    fortranspec=`echo $arg | sed -e 's/-fortran=//'`
    shift
    ;;

  -cc=*)
    cc=yes
    ccspec=`echo $arg | sed -e 's/-cc=//'`
    shift
    ;;

  -c++=*)
    cxx=yes
    cxxspec=`echo $arg | sed -e 's/-c++=//'`
    shift
    ;;

  -useropt=*)
    useropt=yes
    useroptspec=`echo $arg | sed -e 's/-useropt=//'`
    shift
    ;;

  -papi=*)
    papi=yes
    papidir=`echo $arg | sed -e 's/-papi=//'`
    shift
    ;;

  -dyninst=*)
    dyninst=yes
    dyninstdir=`echo $arg | sed -e 's/-dyninst=//'`
    shift
    ;;

  -opari=*)
    opari=yes
    oparidir=`echo $arg | sed -e 's/-opari=//'`
    openmp=yes
    shift
    ;;

  -mpiinc=*)
    mpiinc=yes
    mpiincdir=`echo $arg | sed -e 's/-mpiinc=//' -e 's/ /#/g'`
    shift
    ;;

  -mpilib=*)
    mpilib=yes
    mpilibdir=`echo $arg | sed -e 's/-mpilib=//'`
    shift
    ;;

  -mpilibrary=*)
    mpilibrary=yes
    mpilibraryspec=`echo $arg | sed -e 's/-mpilibrary=//'`
    mpiopt=-mpilibrary="$mpilibraryspec"
    shift
    ;;

  -nocomm)
    commopt=-nocomm
    shift
    ;;

  -pdt=*)
    pdt=yes
    pdtdir=`echo $arg | sed -e 's/-pdt=//'`
    shift
    ;;

  -tag=*)
    tag=yes
    tautag=`echo $arg | sed -e 's/-tag=//'`
    tagopt=-tag=$tautag
    shift
    ;;

  -pdtcompdir=*)
    pdtcomp=yes
    pdtcompdir=`echo $arg | sed -e 's/-pdtcompdir=//'`
    shift
    ;;

  -prefix=*)
    tauprefix=`echo $arg | sed -e 's/-prefix=//' -e 's/ /_/g'`
    shift
    ;;

  -vtf=*)
    vtf=yes
    vtfdir=`echo $arg | sed -e 's/-vtf=//'`
    vtfopt=-vtf=$vtfdir
    shift
    ;;

  -help)
    echo "TAU Configuration Utility "
    echo "***********************************************************************"
    echo "Usage: installtau [OPTIONS]"
    echo "  where [OPTIONS] are:"
    echo "-arch=<arch>  "
    echo "-fortran=<compiler>  "
    echo "-cc=<compiler>   "
    echo "-c++=<compiler>   "
    echo "-useropt=<options>  "
    echo "-pdt=<pdtdir>  "
    echo "-pdtcompdir=<compdir>  "
    echo "-papi=<papidir>  "
    echo "-vtf=<vtfdir>  "
    echo "-dyninst=<dyninstdir>  "
    echo "-mpiinc=<mpiincdir>  "
    echo "-mpilib=<mpilibdir>  "
    echo "-mpilibrary=<mpilibrary>  "
    echo "-tag=<unique name> "
    echo "-nocomm"
    echo "-opari=<oparidir>  "
    shift
    exit
    ;;

  *)
    echo "ERROR: Command line switch \`$arg' not recognized" 1>&2
    exit 1
    ;;
  esac
done

# Add tauprefix to tagopt
if [ $tauprefix != unknown ]
then
  tagopt="$tagopt -prefix=$tauprefix"
fi

# Take care of wish version prompt
echo " " > wishver

# Now we compose the arguments
  if [ $pdt = yes ]
  then
    pdtopt="-pdt=$pdtdir"
    if [ $pdtcomp = yes ]
    then
      pdtopt="-pdt=$pdtdir -pdtcompdir=$pdtcompdir"
    fi
  fi

  if [ $arch = yes ]
  then
    archopt="-arch=$archdir"
  fi

  if [ $fortran = yes ]
  then
    fortrancompiler="-fortran=$fortranspec"
  fi

  if [ $cc = yes ]
  then
    ccompiler="-cc=$ccspec"
  fi

  if [ $cxx = yes ]
  then
    ccompiler="$ccompiler -c++=$cxxspec"
  fi

  if [ $useropt = yes ]
  then
    useropts="-useropt='$useroptspec'"
  fi

# Configure TAU
  if [ $mpiinc = yes -a $mpilib = yes ]
  then
# Configure all versions with MPI
    echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt"
    ./configure $fortrancompiler $ccompiler $useropts $tagopt $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt <wishver
    make clean; make install
    if [ "x$commopt" = "x" ]
    then
      echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt -nocomm"
      ./configure $fortrancompiler $ccompiler $useropts $tagopt $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt -nocomm <wishver
      make clean; make install
    fi

# Add callpath profiling 
    echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt -PROFILECALLPATH"
    ./configure $fortrancompiler $ccompiler $useropts $tagopt $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt -PROFILECALLPATH <wishver
    make clean; make install
  
# Add COMPENSATE
    echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt -COMPENSATE"
    ./configure $fortrancompiler $ccompiler $useropts $tagopt $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt -COMPENSATE <wishver
    make clean; make install

# Add TRACE
    echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -TRACE $vtfopt"
    ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -TRACE  $vtfopt <wishver
    make clean; make install
  
    if [ $papi = yes ]
    then
# Add PAPI
      echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -papi=$papidir -PAPIWALLCLOCK -PAPIVIRTUAL"
      ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL <wishver
      make clean; make install
    fi

    if [ $opari = yes ]
    then
      echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -opari=$oparidir"
      ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -opari=$oparidir -openmp <wishver
      make clean; make install
    fi 

    if [ $opari = yes -a $papi = yes ] 
    then
      echo "Configuring with ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -opari=$oparidir -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL"
      ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -mpiinc=$mpiincdir -mpilib=$mpilibdir $mpiopt $commopt -opari=$oparidir -openmp -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL   <wishver
      make clean; make install
    fi 
  fi
# MPI options are over

# Serial library with pdt
  if [ $pdt = yes ]
  then
    echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt "
    ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt <wishver
    make clean; make install
  fi

  if [ $opari = yes ]
  then
    echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -opari=$oparidir -openmp "
    ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -opari=$oparidir -openmp <wishver
    make clean; make install

    if [ $papi = yes ]
    then 
      echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -opari=$oparidir -openmp -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL "
      ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -opari=$oparidir -openmp -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL <wishver
      make clean; make install
    fi
  fi 

# Just Pthread
  echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -pthread "
  ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -pthread <wishver
  make clean; make install
  
# Just Sequential
  echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt "
  ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt <wishver
  make clean; make install

  if [ $papi = yes ]
  then 
# PAPI with PTHREAD 
    echo "Configuring with -pthread -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL "
    ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -pthread -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL <wishver
    make clean; make install

# PAPI with -pdt 
    if [ $pdt = yes ]
    then
      echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL"
      ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt $pdtopt  -papi=$papidir -MULTIPLECOUNTERS -PAPIWALLCLOCK -PAPIVIRTUAL <wishver
      make clean; make install
    fi
  fi
  if [ $dyninst = yes ] 
  then
    echo "Configuring with $fortrancompiler $useropts $tagopt $ccompiler $archopt -dyninst=$dyninstdir "
    ./configure $fortrancompiler $useropts $tagopt $ccompiler $archopt -dyninst=$dyninstdir < wishver
    make clean; make install
  fi
   

# Set file permissions
  chmod -R go+rX *

  

